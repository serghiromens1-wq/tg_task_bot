nano import re
import asyncio
from datetime import datetime, time
from aiogram import Bot, Dispatcher, F
from aiogram.types import Message, InlineKeyboardMarkup, InlineKeyboardButton, CallbackQuery
from aiogram.enums import ParseMode

TOKEN = "8055579353:AAHvWCK4VOC6eDMvy0hkaL6_exnhn-t5EuU"

bot = Bot(TOKEN, parse_mode=ParseMode.HTML)
dp = Dispatcher()

tasks = {}  # message_id -> task data


def build_button(text, callback_data="done"):
    return InlineKeyboardMarkup(
        inline_keyboard=[[InlineKeyboardButton(text=text, callback_data=callback_data)]]
    )


@dp.message(F.text.startswith("Ğ¢Ğ°ÑĞº:"))
async def create_task(message: Message):
    text = message.text

    task_match = re.search(r"Ğ¢Ğ°ÑĞº:\s*(.+)", text)
    time_match = re.search(r"Ğ§Ğ°Ñ:\s*(.+)", text)

    task_text = task_match.group(1).strip() if task_match else "Ğ‘ĞµĞ· Ğ½Ğ°Ğ·Ğ²Ğ¸"
    time_text = time_match.group(1).strip().lower() if time_match else "Ğ±ĞµĞ· Ğ´ĞµĞ´Ğ»Ğ°Ğ¹Ğ½Ñƒ"

    if time_text == "Ğ²ĞµÑÑŒ Ğ´ĞµĞ½ÑŒ":
        button_text = "â¬œï¸ Ğ’ĞµÑÑŒ Ğ´ĞµĞ½ÑŒ"
        deadline = None
    elif re.match(r"\d{1,2}:\d{2}", time_text):
        button_text = f"â¬œï¸ Ğ´Ğ¾ {time_text}"
        h, m = map(int, time_text.split(":"))
        deadline = time(h, m)
    else:
        button_text = "â¬œï¸ Ğ‘ĞµĞ· Ğ´ĞµĞ´Ğ»Ğ°Ğ¹Ğ½Ñƒ"
        deadline = None

    await message.edit_text(task_text)
    await message.edit_reply_markup(reply_markup=build_button(button_text))

    tasks[message.message_id] = {
        "chat_id": message.chat.id,
        "deadline": deadline,
        "done": False
    }


@dp.callback_query(F.data == "done")
async def mark_done(call: CallbackQuery):
    msg = call.message
    user = call.from_user.first_name
    now = datetime.now().strftime("%H:%M")

    await msg.edit_reply_markup(
        reply_markup=build_button(f"âœ… Ğ’Ğ¸ĞºĞ¾Ğ½Ğ°Ğ½Ğ¾: {user} ({now})", "locked")
    )

    await call.answer("Ğ—Ğ°Ğ´Ğ°Ñ‡Ñƒ Ğ·Ğ°ĞºÑ€Ğ¸Ñ‚Ğ¾")


async def deadline_watcher():
    while True:
        now = datetime.now().time()
        for msg_id, data in list(tasks.items()):
            if data["done"] or not data["deadline"]:
                continue

            if now >= data["deadline"]:
                try:
                    await bot.edit_message_reply_markup(
                        chat_id=data["chat_id"],
                        message_id=msg_id,
                        reply_markup=build_button("ğŸŸ¥ ĞŸÑ€Ğ¾ÑÑ‚Ñ€Ğ¾Ñ‡ĞµĞ½Ğ¾", "locked")
                    )
                    data["done"] = True
                except:
                    pass
        await asyncio.sleep(30)


async def main():
    asyncio.create_task(deadline_watcher())
    await dp.start_polling(bot)


if __name__ == "__main__":
    asyncio.run(main())
